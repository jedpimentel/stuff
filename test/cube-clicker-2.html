<!DOCTYPE html>
<html lang="eng">

<head>
  <title>CUBE CLICKER</title>
  <!-- in-vr links break upgrading 8.2 to 9.2 -->
  <!-- <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script> -->
  <script src="https://aframe.io/releases/0.8.2/aframe.min.js"></script>


  <script src="../lib/jose-components.js"></script>
  <meta charset="utf-8">
</head>

<body style="font-family:courier; color:white; background-color: black">

	<script type="text/javascript">
		AFRAME.registerComponent('click-me', {

			init: function () {
				// hover logic might not be stable, I'm somehow afraid of s
				// omething triggering a mouseenter without a mouseleave
				this.being_hovered = false;
				this.initial_position = (new THREE.Vector3( )).copy(this.el.object3D.position);

				this.tone = document.createElement('audio')
				this.tone.src = '../sine-432hz-pluck.flac'
	
				this.el.addEventListener('click', () => this.click());// works as expected
				// this.el.addEventListener('click', this.ding);// this.tone is undefined... wth?
				// 'fusing'
				// 'mousedown'
				// this.el.addEventListener('mouseenter', this.mouseenter)  
				// this.el.addEventListener('mouseleave', this.mouseleave)  
				// 'mouseup'
			},
			click: function () {
				this.el.setAttribute('visible', false);
				// setTimeout(() => this.el.setAttribute('visible', true), 5000 + 1000*Math.random);
				// const t = 5000 + (1000*Math.random)
				setTimeout(() => this.el.setAttribute('visible', true), 500 + (1000*Math.random()));
				this.el.object3D.position.x = this.initial_position.x - 2 + 4*Math.random();
				this.el.object3D.position.y = this.initial_position.y - 1 + 2*Math.random();
				this.tone.currentTime = 0;
				this.tone.play();
			},

		});

		AFRAME.registerComponent('dist-thing', {
			init: function () {

				// this.origin = document.querySelector('#clickcaster-origin').object3D.position;
				this.origin = document.querySelector('#clickcaster-origin');
				this.flatty = document.querySelector('#flatty');
				// console.log(this.origin.object3D)
				// console.log(this.origin.el.object3D)
				this.el.addEventListener('raycaster-intersection', function (evt) {
					evt.detail.els.map(el => el.click());//hard-index unstable?
					console.log('Player hit something!', evt.detail.els);
				});

			},

			tick: function () {
				const Z = -5
				// console.log('tick', this.el.object3D.position)
				// console.log('tick', this.origin.object3D.position)
				this.origin.object3D.getWorldPosition(this.el.object3D.position)
				const dist = this.el.object3D.position.z - Z;
				this.el.object3D.position.z = Z;//derp
				// console.log(this.origin.object3D.position);//derp

				const dist_factor = 2 / Math.max(dist, 2)

				this.el.setAttribute('opacity', dist_factor)
				this.el.setAttribute('radius', 1 - dist_factor)


				const x = this.el.object3D.position.x;
				const y = 2 - this.el.object3D.position.y;

				const PPM = 1000

				// this.flatty.setAttribute('top', )
				// this.flatty.setAttribute('left', `${x}px`)
				// this.flatty.setAttribute('left', `50px`)
				this.flatty.style.left = `${x*PPM}px`
				this.flatty.style.top = `${y*PPM}px`
				// top: 40px; left: 40px;
			}

		});

		AFRAME.registerComponent('clickcaster', {
		  dependencies: ['raycaster'],// why?

		  init: function () {

			// this.origin = document.querySelector('#clickcaster-origin').object3D.position;
			this.origin = document.querySelector('#clickcaster-origin');
			// console.log(this.origin.object3D)
			// console.log(this.origin.el.object3D)
		    this.el.addEventListener('raycaster-intersection', function (evt) {
		    	evt.detail.els[0].click();//hard-index unstable?
		    	console.log('Player hit something!', evt.detail.els);
		    });

		  },

		  tick: function () {
		  	// console.log('tick', this.el.object3D.position)
		  	// console.log('tick', this.origin.object3D.position)
		  	this.origin.object3D.getWorldPosition(this.el.object3D.position)
		  }
		});
		// AFRAME.registerPrimitive('a-ocean', {
		//   // Attaches the `ocean` component by default.
		//   // Defaults the ocean to be parallel to the ground.
		//   defaultComponents: {
		//     ocean: {},
		//     rotation: {x: -90, y: 0, z: 0}
		//   },

		//   // Maps HTML attributes to the `ocean` component's properties.
		//   mappings: {
		//     width: 'ocean.width',
		//     depth: 'ocean.depth',
		//     density: 'ocean.density',
		//     color: 'ocean.color',
		//     opacity: 'ocean.opacity'
		//   }
		// });
	</script>


    <section id="main">
    	<style type="text/css">
    		#flatty {
    			background-color: white;
    			border-radius: 50%;
    			height: 10px;
    			width: 10px;
    			position: fixed;
    			/*left: 50px;*/
    		}
    	</style>
    	<div id="flatty"></div>
    </section>
	<a-scene loading-screen="dotsColor: white; backgroundColor: black">

    <a-assets>
      <img id="lamb" src="../../lamb.png">
    </a-assets>

	<a-entity id="camera-wrapper">


        <a-camera look-controls="pointerLockEnabled: true" near="0.001" wasd-controls>
            <!-- <a-cylinder id="fing-longer" position="0.2 -0.4 -0.9" radius="0.01" height= "1.0" rotation="90 0 0" color="beige" opacity="1.0"></a-cylinder> -->
            <a-entity id="clickcaster-origin" position="0.2 -0.4 -1.4"></a-entity>
        </a-camera>

	    <!-- <a-camera cursor="rayOrigin: mouse" look-controls="pointerLockEnabled: false" near="0.001">
	        <a-text opacity="0.1" value="frames-per-second" width="0.8" position="0.2 -0.3 -0.9"></a-text>
	        <a-text opacity="0.1" fps-counter position="0.2 -0.4 -0.9"></a-text>
	        <a-cylinder id="fing-longer" position="0.2 -0.4 -0.9" radius="0.01" height= "1.0" rotation="90 0 0" color="beige" opacity="1.0">
	        	
	        </a-cylinder>
	        <a-entity raycaster="objects: .collidable" position="0 0 -1" rotation="90 90 0"></a-entity>
	    </a-camera> -->

	</a-entity>


    <a-circle dist-thing color="green" opacity="0.2"></a-circle>


    <a-entity cursor="rayOrigin: entity; showLine: true;" clickcaster raycaster="objects: .clickable; showLine: true; far: 0.5" line="color: white; opacity:0.5"></a-entity>
    <!-- <a-entity raycaster="objects: .collidable" position="0 1 -2" line="color: orange; opacity: 0.5"></a-entity> -->
    <!-- <a-entity raycaster="objects: .collidable" position="0 -0.9 0" rotation="90 0 0"></a-entity> -->

<!-- 
    <a-entity joses-default-interface>
    	<script type="text/javascript">
    		AFRAME.registerComponent('clickcaster', {
			  dependencies: ['raycaster'],

			  init: function () {
			    this.el.addEventListener('raycaster-intersection', function (evt) {
			      console.log('Player hit something!', evt);
			    });
			  }
			});
    	</script>
    	<a-box position="0 1.6 -1" color="green"></a-box>
    	<a-entity clickcaster="objects: .collidable" position="0 -0.9 -1" rotation="90 0 0"></a-entity>
    </a-entity>
 -->


    <!-- <a-cylinder id='green-cyl' class="clickable" position="6.5 .75 -8" radius="0.5" color="green" opacity="0.3"></a-cylinder> -->

    <a-box class="clickable" click-me position="0 1 -4" color="red" opacity="0.2">
      <a-text value="CLICK ME" align="center" side="double"></a-text>
    </a-box>

	</a-scene>
</body>
</html>